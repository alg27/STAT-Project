---
title: "Unveiling NYC Taxi Patterns - Group 13 Final Project"
author: "Ryan Gan, Alicia Garza, Alan Yang, Kyle Zeng"
date: '4/18/2024'
format:
  revealjs: 
    # embed-resources: true
    slide-number: true
    chalkboard: 
      buttons: false
    preview-links: auto
    css: styles.css
server: shiny
---

# Introduction {background="#6B6B6B"}

# Introduction {style="font-size: 24px;"}

New York City is densely populated, meaning not many people can own cars. However, if people need to travel from point A to point B in a hurry, they can hail a Taxi.

We will be analyzing the Taxi cab ride data from January to March of 2021 to detect any noticeable relationships between the columns of the dataset. For example, the relationship between trip distance and fare price, the most popular destinations to take a Taxi, the average trip time, and so on. In addition, we will also see if taxicab ride usage spikes during key events or holidays, such as MLK day.

# Data Overview {style="font-size: 24px;"}

-   18 columns, with each row being a taxi trip record

    -   Notable columns include: pickup/dropoff time, trip_distance, fare_amount, etc.

    -   Additional columns were created, such as trip time, speed, and fare/mile that were also used in calculations

-   Time period: January 2021 - March 2021

# Data Cleaning {style="font-size: 24px;"}

-   Original data set had rides for all of 2021, so we filtered out all rides that were not between January and March

-   All trips shorter than 10 seconds were filtered out, as the taxi driver likely accidentally turned on their taxi meter

-   Any fees that were less than 0 were removed

-   Trips without a pickup time or dropoff time were filtered out

# Trip Distance vs Fare Amount {style="font-size: 24px;"}

```{r, echo = FALSE, message = FALSE, warning = FALSE}
options(bitmapType='cairo')
x11(type='cairo')
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(lubridate)
library(dplyr)
library(ggplot2)
library(shiny)
library(RSQLite)
library(DBI)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# Connect to the SQLite database
dcon <- dbConnect(SQLite(), dbname = "jan_to_mar_taxi_2021.db")
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
#Disconnect DB (Don't use all the time)
#dbDisconnect(dcon)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
query <- "SELECT * FROM jan_to_mar_taxi_2021"
df <- dbGetQuery(dcon, query)
```

```{r, echo = FALSE}
set.seed(24246452)
sampled_indices <- sample(nrow(df), size = 100000)

# Subset the DataFrame with the sampled indices
df <- df[sampled_indices, ]
```

```{r, echo = FALSE}
# Fit a linear model
lm_model <- lm(fare_amount ~ trip_distance, data = df)

# Extract coefficients
intercept <- round(coef(lm_model)[1], 2)
slope <- round(coef(lm_model)[2], 2)

# Construct the equation string
equation <- paste("y = ", intercept, " + ", slope, "*x", sep = "")

# Create the plot with ggplot2
ggplot(df, aes(x = trip_distance, y = fare_amount)) +
  geom_point(aes(color = trip_distance), alpha = 0.5) +  # Plot data points
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "blue") +  # Linear regression line without standard error
  geom_text(x = Inf, y = Inf, label = equation, hjust = 1.1, vjust = 2, size = 5, color = "red") +  # Display the equation
  labs(title = "Trip Distance vs. Fare Amount",
       x = "Trip Distance (miles)",
       y = "Fare Amount ($)",
       caption = paste("Data: NYC Taxi Rides. Linear Model:", equation)) +
  theme_minimal() +
  theme(legend.position = "none")

```

# Trip Time Vs. Fare Amount by RatecodeID {style="font-size: 24px;"}

```{r, echo = FALSE, fig.align='left', fig.width=13, fig.height=9}
# For Trip Time vs. Fare Amount
ggplot(df, aes(x = trip_time, y = fare_amount)) +
  geom_point(aes(color = trip_time), alpha = 0.5) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "blue") +  
  facet_wrap(~ RatecodeID, scales = "free") +
  labs(title = "Trip Time vs. Fare Amount by RatecodeID",
       x = "Trip Time (minutes)",
       y = "Fare Amount ($)") +
  theme_minimal() +
  theme(legend.position = "none")
```

# Density Plot of Pick up and Drop off location {style="font-size: 20px;"}

```{r, echo = FALSE}
# Density plot of pick up and drop off locations
plot(density(df$PULocationID), 
     main = "Density Plot of Pick Up and Drop off Location", 
     xlab = "Location ID", 
     ylab = "Density", 
     ylim = c(0, 0.04), 
     col = "red")
lines(density(df$PULocationID), 
      col = "red", 
      lwd = 2)
par(new = TRUE)
plot(density(df$DOLocationID), main = "", xlab = "", ylab = "", ylim = c(0, 0.04), col = "blue")
lines(density(df$DOLocationID), col = "blue", lwd = 2)
legend("topright", # Position of the legend within the plot area
       legend = c("Pickup Location", "Dropoff Location"), # Text for the legend
       col = c("red", "blue"), # Colors for the legend keys
       lwd = 2) # Line width for the legend keys
```

# Number of Rides Per Day {style="font-size: 20px;"}

```{r, echo = FALSE}
# Line chart of month and number of taxi trips
# Assuming df is your dataframe and tpe_pickup_datetime is the column with dates
df$pickup_time <- as.POSIXct(df$pickup_time, format = "%m/%d/%Y %I:%M:%S %p")
df$day <- format(df$pickup_time, "%Y-%m-%d")

# Sort the data by day to ensure it's in chronological order
daily_counts <- aggregate(x = list(Count = rep(1, nrow(df))), by = list(Day = df$day), FUN = sum)
# Plot
max_count <- max(daily_counts$Count)

# Plotting with y-axis starting at 0
plot(daily_counts$Count, type = "l", xaxt = "n", ylim = c(0, max_count), main = "Number of Rides per day", xlab = "Day", ylab = "Number of Rides"); axis(1, at = 1:length(daily_counts$Day), labels = daily_counts$Month)

```

# Daily Total Fare Amount {style="font-size: 24px;"}

```{r, echo = FALSE}
# Aggregate data for total daily fare
daily_fare_data <- df %>%
  group_by(day) %>%
  summarise(TotalFare = sum(fare_amount), .groups = 'drop')
ggplot(daily_fare_data, aes(x = as.Date(day), y = TotalFare)) +
  geom_line(color = "darkred") +
  labs(title = "Daily Total Fare Amount", x = "Date", y = "Total Fare Amount ($)") +
  theme_minimal()
```

# Heat Map of Taxi Pickups by Day of Week and Hour {style="font-size: 20px;"}

```{r, echo = FALSE}
# Convert pickup_time to day of the week and hour
df$pickup_day <- weekdays(df$pickup_time)
df$pickup_hour <- hour(df$pickup_time)
# Aggregate data for heatmap
pickup_heatmap_data <- df %>%
  group_by(pickup_day, pickup_hour) %>%
  summarise(Count = n(), .groups = 'drop')
ggplot(pickup_heatmap_data, aes(x = pickup_hour, y = pickup_day, fill = Count)) +
  geom_tile() +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(title = "Heatmap of Taxi Pickups by Day of Week and Hour", x = "Hour of the Day", y = "Day of the Week") +
  theme_minimal()
```

# Histogram of Trip Time {style="font-size: 24px;"}

```{r, echo = FALSE}
# Histogram of Trip Times less than 100 minutes for ease of viewing
trip_time <- df$trip_time[df$trip_time < 100]
hist(trip_time,main = "Histogram of Trip Time",
     xlab = "Trip Time")
```

# Secondary Dataset - Central Park Weather {style="font-size: 24px;"}

```{r, echo = FALSE, results = 'hide'}
df_weather <- read.csv("NYC_Central_Park_weather_1869-2022.csv")
df_weather <- df_weather %>% filter(
  year(DATE) == 2021,
  month(DATE) < 4)

dbListTables(dcon)
dbListFields(dcon, "jan_to_mar_taxi_2021")
query <- "SELECT tpep_pickup_datetime FROM jan_to_mar_taxi_2021"

query1 <- "SELECT strftime('%Y-%m-%d', datetime(pickup_time, 'unixepoch')) AS day, COUNT(*) AS count FROM jan_to_mar_taxi_2021 GROUP BY day"
result <- dbSendQuery(dcon, query1)
ride_count_df_weather <- dbFetch(result)
ride_count_df_weather

rain_model <- lm(ride_count_df_weather$count ~ df_weather$PRCP)
plot(df_weather$PRCP, ride_count_df_weather$count); abline(rain_model, col = "red")

snow_model <- lm(ride_count_df_weather$count ~ df_weather$SNOW)
plot(df_weather$SNOW, ride_count_df_weather$count); abline(snow_model, col = "red")
```

# Statistical Modeling {style="font-size: 24px;"}

```{r, echo = FALSE, results = 'hide'}
x <- df$trip_distance
y <- df$fare_amount

model <- lm(y ~ x)

# Extract coefficients and related statistics
coefficients <- coef(model)
standard_errors <- summary(model)$coefficients[, "Std. Error"]
t_values <- coefficients / standard_errors
p_values <- 2 * pt(abs(t_values), df = df.residual(model), lower.tail = FALSE)

# Extract additional statistics from the model object
residuals <- summary(model)$residuals
r_squared <- summary(model)$r.squared
adj_r_squared <- summary(model)$adj.r.squared
f_value <- summary(model)$fstatistic[1]
f_p_value <- summary(model)$fstatistic[2]
aic <- AIC(model)
bic <- BIC(model)

# Create a data frame to organize all the information
summary_data <- data.frame(
  coefficient = coefficients,
  std_error = standard_errors,
  t_value = t_values,
  p_value = p_values
)

# Additional statistics
summary_stats <- data.frame(
  r_squared = r_squared,
  adj_r_squared = adj_r_squared,
  f_value = f_value,
  f_p_value = f_p_value,
  aic = aic,
  bic = bic
)

quartiles <- quantile(residuals, probs = c(0.25, 0.5, 0.75))

# Residual statistics
summary_residuals <- data.frame(
  mean = mean(residuals),
  sd = sd(residuals),
  min = min(residuals),
  Q1 = quartiles[1],
  median = median(residuals),
  Q3 = quartiles[3],
  max = max(residuals)
)
rownames(summary_residuals) <- "Data"

print(summary_residuals)
print(summary_data)
print(summary_stats)
```

```{r, echo = FALSE}
yhat = fitted(model)
ehat = residuals(model)
plot(yhat, ehat)
abline(h=0)
```

```{r, echo = FALSE}
rhat = rstandard(model)
qqnorm(rhat)
qqline(rhat)
```

# Killer Plot {background="#6B6B6B"}

::: columns
::: {.column width="25%"}
::: {style="font-size: 40%"}
```{r, , echo = FALSE}
#| panel: fill
plotOutput('plot')
```
:::
:::

::: {.column width="60%"}
```{r}
sliderInput("hour", "Hour of Day", min = 0, max = 23, value = c(6, 18), step = 1)
selectInput("rateCode", "Rate Code", choices = unique(df$RatecodeID))
```
:::
:::

```{r}
#| context: "server"
output$plot <- renderPlot({
  req(input$hour, input$rateCode)
  filtered_data <- df %>%
    filter(hour(pickup_time) %in% input$hour, RatecodeID == input$rateCode)

  p <- ggplot(filtered_data, aes(x = trip_distance, y = fare_amount, color = fare_amount)) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm") +
    labs(title = "Dynamic Fare Analysis", x = "Distance (miles)", y = "Fare ($)")
  print(p)
})
```

# Advanced Questions {background="#6B6B6B"}

# Question 1: Outlier Explanation {style="font-size: 24px;"}

What factors contribute to the decline in ridership observed in late January?

# Question 2: Effect of Pickup and Dropoff Locations on Fare {style="font-size: 20px;"}

How do the pickup and dropoff locations (PULocationID and DOLocationID) affect the fare amount (fare_amount)?

```{r, echo = FALSE}
# Summarize the effect of pickup and dropoff locations on fare amount
pickup_dropoff_effect <- df %>%
  group_by(PULocationID, DOLocationID) %>%
  summarise(avg_fare_amount = mean(fare_amount),
            total_trips = n(),
            .groups = 'drop')
pickup_dropoff_effect
```

# Question 3: Patterns in Taxi Usage Over Time {style="font-size: 20px;"}

How does taxi usage, in terms of number of trips and total amount charged (total_amount), vary over different times of the day and days of the week?

```{r, echo = FALSE}
taxi_usage <- df %>%
  mutate(hour_of_day = hour(pickup_time),
         day_of_week = wday(pickup_time, label = TRUE)) %>%
  group_by(hour_of_day, day_of_week) %>%
  summarise(num_trips = n(),
            total_amount = sum(total_amount), .groups = 'drop')
taxi_usage
```

# Question 4: Price Prediction {style="font-size: 24px;"}

Can total fares be predicted by distance, theoretical time, and ratecodeIDs?

```{r, echo = FALSE}
# Price Prediction
price_prediction <- df %>%
  select(total_amount, trip_distance, trip_time, RatecodeID) %>%
  na.omit() %>%
  mutate(RatecodeID = as.factor(RatecodeID)) %>%
  lm(total_amount ~ trip_distance + trip_time + RatecodeID, data = .)

# Summary of the model
summary(price_prediction)

# Prediction for a new dataset (replace new_data with your actual dataset)
new_data <- data.frame(trip_distance = c(3.5, 4.2, 2.8),
                       trip_time = c(20, 30, 19),
                       RatecodeID = factor(c(1, 2, 1)))
print("Predictions:")
# Predict total fares for new data
predictions <- predict(price_prediction, newdata = new_data)
predictions
```
